"use strict";

var FIREBASE_URL = "https://movieagenda.firebaseio.com/movielist.json";
var FIREBASE_AUTH_URL = "https://movieagenda.firebaseio.com";
var fb = new Firebase(FIREBASE_AUTH_URL);
var API_URL = "http://www.omdbapi.com/?t=";
var $SUBMITBUTTON = $(".submit");
var $TEXTFIELD = $(".textfield");
var $MOVIEINFO = $(".movie-info");
var $MOVIETABLECONTAINER = $(".movie-table-container");
var movie_info_obj;
var poster_url;
var TMDB_API_KEY = "?api_key=3d3efaa01fcce58b6e8758f0f9d9c93d";
var TMDB_SEARCH_URL = "http://api.themoviedb.org/3/search/movie";
var TMDB_POSTER_BASE = "http://image.tmdb.org/t/p/w500";

fb.onAuth(function (authData) {
  if (authData && authData.password.isTemporaryPassword && window.location.pathname !== "/moviepage-auth/resetpassword/") {
    window.location = "resetpassword";
  } else if (authData && !authData.password.isTemporaryPassword && window.location.pathname !== "/moviepage-auth/index/") {
    window.location = "index";
  } else if (!authData && window.location.pathname !== "/moviepage-auth/login/") {
    window.location = "login";
  }
  clearLoginForm();
});

if (window.location.pathname === "/index/") {
  tableLoad();
  $(".crumbs-left").append($("<p>Welcome, " + fb.getAuth().password.email.split("@")[0] + "!</p>"));
}

$(".login-page form").submit(function () {
  var email = $(".login-page input[type=\"email\"]").val();
  var password = $(".login-page input[type=\"password\"]").val();

  doLogin(email, password);
  event.preventDefault();
});

$(".doLogout").click(function () {
  fb.unauth();
});

$(".doRegister").click(function (event) {
  event.preventDefault();
  var email = $(".login-page input[type=\"email\"]").val();
  var password = $(".login-page input[type=\"password\"]").val();

  fb.createUser({
    email: email,
    password: password
  }, function (err, userData) {
    if (err) {
      alert(err.toString());
    } else {
      doLogin(email, password);
    }
  });
});

$(".reset-password form").submit(function () {
  var email = fb.getAuth().password.email;
  var oldPw = $("#oldpass").val();
  var newPw = $("#newpass").val();

  fb.changePassword({
    email: email,
    oldPassword: oldPw,
    newPassword: newPw
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      fb.unauth();
    }
  });
  event.preventDefault();
});

$(".doResetPassword").click(function () {
  event.preventDefault();
  var email = $(".login-page input[type=\"email\"]").val();

  fb.resetPassword({
    email: email
  }, function (err) {
    if (err) {
      alert(err.toString());
    } else {
      alert("Please check your email for further instructions.");
    }
  });
});

function doLogin(email, password, callback) {
  fb.authWithPassword({
    email: email,
    password: password
  }, function (err, authData) {
    if (err) {
      alert(err.toString());
    } else {
      saveAuthData(authData);
      typeof callback === "function" && callback(authData);
    }
  });
}

function saveAuthData(authData) {
  $.ajax({
    method: "PUT",
    url: "" + FIREBASE_AUTH_URL + "/users/" + authData.uid + "/profile.json",
    data: JSON.stringify(authData)
  });
}

function clearLoginForm() {
  $(".login-page input[type=\"email\"]").val("");
  $(".login-page input[type=\"password\"]").val("");
}

//tableLoad();

function getSearchParams() {
  var movie_title = $TEXTFIELD.val();
  var search_params = movie_title.split(" ").join("+");
  return search_params;
}

$SUBMITBUTTON.click(function (event) {
  event.preventDefault();
  var tmdb_search_url = TMDB_SEARCH_URL + TMDB_API_KEY + "&query=" + getSearchParams();
  $.get(tmdb_search_url, setPosterUrl, "jsonp");
});

function setPosterUrl(obj) {
  if (obj.total_results === 0) {
    $MOVIEINFO.empty();
    $MOVIEINFO.append(makeError());
    setTimeout(function () {
      $(".error").fadeOut(500, function () {
        $(".error").remove();
      });
    }, 3000);
    return false;
  }
  var poster_path = obj.results && obj.results[0] && obj.results[0].poster_path;
  poster_url = TMDB_POSTER_BASE + poster_path + TMDB_API_KEY;
  // have the poster url; now get the rest of the data according to the title as it was return by the
  // object bearing the poster path (to keep consistency between both APIs' search results).
  var request_url = API_URL + (obj.results && obj.results[0] && obj.results[0].original_title.split(" ").join("+"));
  $.get(request_url, addMovieInfo, "jsonp");
}

$MOVIEINFO.on("click", ".add-button", function (event) {
  event.preventDefault();
  writeToFirebase(movie_info_obj);
});

$MOVIETABLECONTAINER.on("click", "button", function (event) {
  event.preventDefault();
  deleteFromFirebase($(this).closest("tr").attr("data_id"));
  $(this).closest("tr").fadeOut(500, function () {
    $(this).closest("tr").remove();
    if (!$("td").length) {
      $("table").remove();
    }
  });
});

$MOVIETABLECONTAINER.on("click", "img", function (event) {
  event.preventDefault();
  var id = $(this).closest("tr").attr("data_id");
  $.get("" + FIREBASE_AUTH_URL + "/users/" + fb.getAuth().uid + "/movielist/" + id + ".json", reClick, "jsonp");
});

// reClick is for reloading stored movies into the movie info view; don't need to rewrite the poster url.
function reClick(obj) {
  movie_info_obj = obj;
  $MOVIEINFO.empty();
  $MOVIEINFO.append(makeMovieInfo(obj));
}

function addMovieInfo(obj) {
  movie_info_obj = obj;
  movie_info_obj.Poster = poster_url;
  $MOVIEINFO.empty();
  $MOVIEINFO.append(makeMovieInfo(obj));
}

function makeError() {
  var $error = $("<div><p>(´Ａ｀。) No results!</p></div>");
  $error.addClass("error");
  return $error;
}

function makeMovieInfo(obj) {
  var $info_container = $("<div></div>");
  $info_container.addClass("info-container");
  var $title = $("<p>" + obj.Title + "</p>");
  var $info = $(makeRatingImgText(obj) + "<span " + makeMetaRatingText(obj) + "</span><p class='imdb-rating'>" + obj.imdbRating + "</p></span><span>Year: " + obj.Year + "</span>");
  $title.addClass("title");
  var $director = $("<p>Director: " + obj.Director + "</p>");
  var $plot = $("<p>" + obj.Plot + "</p>");
  var $runtime = $("<p>" + obj.Runtime + "</p>");
  var $add_button = $("<button>Add to my list</button>");
  $add_button.addClass("add-button btn btn-lg btn-success pull-right");

  var $poster = $("<img src='" + obj.Poster + "'></img>");
  $poster.addClass("pull-left");
  $info_container.append($poster);
  $info_container.append($title).append($info).append($director).append($plot).append($runtime).append($add_button);
  return $info_container;
}

function addToTable(obj, id) {
  if (!$("table").length) {
    $MOVIETABLECONTAINER.append(makeTableHeader());
  }
  $("table").append(makeTableRow(obj, id));
}

function makeTableHeader() {
  var $table = $("<table></table>");
  $table.addClass("table table-striped");
  var $header_row = $("<tr></tr>");
  var $header_elements = $("<th></th><th>Title</th><th>Year</th><th>Rating</th><th>Metascore</th><th>imdb</th><th></th>");
  $header_row.append($header_elements);
  $table.append($header_row);
  return $table;
}

function makeTableRow(obj, id) {
  var $row = $("<tr></tr>");
  var $poster_td;
  $row.attr("data_id", id || obj.data_id);
  obj.Poster === "N/A" ? $poster_td = $("<td><img src='" + "https://www.utopolis.lu/bundles/utopoliscommon/images/movies/movie-placeholder.jpg" + "'></td>") : $poster_td = $("<td><img src='" + obj.Poster + "'></src>");
  var other_rows = "<td>" + obj.Title + "</td><td>" + obj.Year + "</td><td>";
  other_rows += makeRatingImgText(obj);
  other_rows += "</td><td><p " + makeMetaRatingText(obj) + "</p></td>";
  other_rows += "<td><p class='imdb-rating'>" + obj.imdbRating + "</p></td>";
  other_rows += "<td><button>Watched</button></td>";
  var $other_rows = $(other_rows);
  $other_rows.find("button").addClass("btn btn-lg btn-danger");
  $row.append($poster_td).append($other_rows);
  return $row;
}

function makeMetaRatingText(obj) {
  var return_str = "class='metascore ";
  if (parseInt(obj.Metascore) > 60) {
    return_str += "meta-positive";
  } else if (parseInt(obj.Metascore) > 39) {
    return_str += "meta-neutral";
  } else if (parseInt(obj.Metascore) >= 0) {
    return_str += "meta-negative";
  }
  return_str += "'>" + obj.Metascore;
  return return_str;
}

function makeRatingImgText(obj) {
  if (obj.Rated === "G") {
    return "<img class='rating-img' src='../images/G.svg'>";
  } else if (obj.Rated === "PG") {
    return "<img class='rating-img' src='../images/PG.svg'>";
  } else if (obj.Rated === "PG-13") {
    return "<img class='rating-img' src='../images/PG-13.svg'>";
  } else if (obj.Rated === "R") {
    return "<img class='rating-img' src='../images/R.svg'>";
  } else if (obj.Rated === "NC-17") {
    return "<img class='rating-img' src='../images/NC-17.svg'>";
  } else {
    return "<span>N/A</span>";
  }
}

function writeToFirebase(obj) {
  $.post("" + FIREBASE_AUTH_URL + "/users/" + fb.getAuth().uid + "/movielist.json", JSON.stringify(obj), function (response) {
    obj.data_id = response.name;
    addToTable(obj);
  });
}

function deleteFromFirebase(id) {
  var deleteUrl = "" + FIREBASE_AUTH_URL + "/users/" + fb.getAuth().uid + "/movielist/" + id + ".json";
  $.ajax({ url: deleteUrl, type: "DELETE" });
}

function tableLoad() {
  $.get("" + FIREBASE_AUTH_URL + "/users/" + fb.getAuth().uid + "/movielist.json", function (db_data) {
    db_data && _(db_data).forEach(function (value, key) {
      addToTable(value, key);
    }).value();
  });
}
//# sourceMappingURL=data:application/json;base64,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QUUsU0FBUyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUMsQ0FBQyxDQUFDO0NBQzFDOztBQUVELFNBQVMsU0FBUyxHQUFHO0FBQ25CLEdBQUMsQ0FBQyxHQUFHLE1BQUksaUJBQWlCLGVBQVUsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLEdBQUcsc0JBQW1CLFVBQVMsT0FBTyxFQUFFO0FBQ3ZGLFdBQU8sSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVMsS0FBSyxFQUFFLEdBQUcsRUFBRTtBQUNqRCxnQkFBVSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztLQUN4QixDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7R0FDWixDQUFDLENBQUE7Q0FDSCIsImZpbGUiOiJtYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEZJUkVCQVNFX1VSTCA9IFwiaHR0cHM6Ly9tb3ZpZWFnZW5kYS5maXJlYmFzZWlvLmNvbS9tb3ZpZWxpc3QuanNvblwiO1xudmFyIEZJUkVCQVNFX0FVVEhfVVJMID0gXCJodHRwczovL21vdmllYWdlbmRhLmZpcmViYXNlaW8uY29tXCI7XG52YXIgZmIgPSBuZXcgRmlyZWJhc2UoRklSRUJBU0VfQVVUSF9VUkwpO1xudmFyIEFQSV9VUkwgPSBcImh0dHA6Ly93d3cub21kYmFwaS5jb20vP3Q9XCI7XG52YXIgJFNVQk1JVEJVVFRPTiA9ICQoXCIuc3VibWl0XCIpO1xudmFyICRURVhURklFTEQgPSAkKFwiLnRleHRmaWVsZFwiKTtcbnZhciAkTU9WSUVJTkZPID0gJChcIi5tb3ZpZS1pbmZvXCIpO1xudmFyICRNT1ZJRVRBQkxFQ09OVEFJTkVSID0gJChcIi5tb3ZpZS10YWJsZS1jb250YWluZXJcIik7XG52YXIgbW92aWVfaW5mb19vYmo7XG52YXIgcG9zdGVyX3VybDtcbnZhciBUTURCX0FQSV9LRVkgPSBcIj9hcGlfa2V5PTNkM2VmYWEwMWZjY2U1OGI2ZTg3NThmMGY5ZDljOTNkXCI7XG52YXIgVE1EQl9TRUFSQ0hfVVJMID0gXCJodHRwOi8vYXBpLnRoZW1vdmllZGIub3JnLzMvc2VhcmNoL21vdmllXCI7XG52YXIgVE1EQl9QT1NURVJfQkFTRSA9IFwiaHR0cDovL2ltYWdlLnRtZGIub3JnL3QvcC93NTAwXCI7XG5cbmZiLm9uQXV0aChmdW5jdGlvbihhdXRoRGF0YSkge1xuXHRpZiAoYXV0aERhdGEgJiYgYXV0aERhdGEucGFzc3dvcmQuaXNUZW1wb3JhcnlQYXNzd29yZCAmJiB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgIT09IFwiL3Jlc2V0cGFzc3dvcmQvXCIpIHtcblx0XHR3aW5kb3cubG9jYXRpb24gPSBcIi9yZXNldHBhc3N3b3JkXCI7XG5cdH0gZWxzZSBpZiAoYXV0aERhdGEgJiYgIWF1dGhEYXRhLnBhc3N3b3JkLmlzVGVtcG9yYXJ5UGFzc3dvcmQgJiYgd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lICE9PSBcIi9pbmRleC9cIikge1xuXHQgIHdpbmRvdy5sb2NhdGlvbiA9IFwiL2luZGV4XCI7XG5cdH0gZWxzZSBpZiAoIWF1dGhEYXRhICYmIHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZSAhPT0gXCIvbG9naW4vXCIpe1xuXHQgIHdpbmRvdy5sb2NhdGlvbiA9IFwiL2xvZ2luXCI7XG5cdH1cblx0Y2xlYXJMb2dpbkZvcm0oKTtcbn0pO1xuXG5pZiAod2luZG93LmxvY2F0aW9uLnBhdGhuYW1lID09PSBcIi9pbmRleC9cIikge1xuXHR0YWJsZUxvYWQoKTtcblx0JCgnLmNydW1icy1sZWZ0JykuYXBwZW5kKCQoYDxwPldlbGNvbWUsICR7ZmIuZ2V0QXV0aCgpLnBhc3N3b3JkLmVtYWlsLnNwbGl0KFwiQFwiKVswXX0hPC9wPmApKVxufVxuXG4kKCcubG9naW4tcGFnZSBmb3JtJykuc3VibWl0KGZ1bmN0aW9uKCkge1xuXHR2YXIgZW1haWwgPSAkKCcubG9naW4tcGFnZSBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcblx0dmFyIHBhc3N3b3JkID0gJCgnLmxvZ2luLXBhZ2UgaW5wdXRbdHlwZT1cInBhc3N3b3JkXCJdJykudmFsKCk7XG5cblx0ZG9Mb2dpbihlbWFpbCwgcGFzc3dvcmQpO1xuXHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xufSk7XG5cbiQoJy5kb0xvZ291dCcpLmNsaWNrKGZ1bmN0aW9uKCkge1xuXHRmYi51bmF1dGgoKTtcbn0pXG5cbiQoJy5kb1JlZ2lzdGVyJykuY2xpY2soZnVuY3Rpb24oZXZlbnQpIHtcblx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0dmFyIGVtYWlsID0gJCgnLmxvZ2luLXBhZ2UgaW5wdXRbdHlwZT1cImVtYWlsXCJdJykudmFsKCk7XG5cdHZhciBwYXNzd29yZCA9ICQoJy5sb2dpbi1wYWdlIGlucHV0W3R5cGU9XCJwYXNzd29yZFwiXScpLnZhbCgpO1xuXG5cdGZiLmNyZWF0ZVVzZXIoe1xuXHRcdGVtYWlsOiBlbWFpbCxcblx0XHRwYXNzd29yZDogcGFzc3dvcmRcblx0fSwgZnVuY3Rpb24oZXJyLCB1c2VyRGF0YSkge1xuXHRcdGlmIChlcnIpIHtcblx0XHRcdGFsZXJ0KGVyci50b1N0cmluZygpKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0ZG9Mb2dpbihlbWFpbCwgcGFzc3dvcmQpO1xuXHRcdH1cblx0fSk7XG59KVxuXG4kKCcucmVzZXQtcGFzc3dvcmQgZm9ybScpLnN1Ym1pdChmdW5jdGlvbigpIHtcblx0dmFyIGVtYWlsID0gZmIuZ2V0QXV0aCgpLnBhc3N3b3JkLmVtYWlsO1xuXHR2YXIgb2xkUHcgPSAkKCcjb2xkcGFzcycpLnZhbCgpO1xuXHR2YXIgbmV3UHcgPSAkKCcjbmV3cGFzcycpLnZhbCgpO1xuXG5cdGZiLmNoYW5nZVBhc3N3b3JkKHtcblx0XHRlbWFpbDogZW1haWwsXG5cdFx0b2xkUGFzc3dvcmQ6IG9sZFB3LFxuXHRcdG5ld1Bhc3N3b3JkOiBuZXdQd1xuXHR9LCBmdW5jdGlvbihlcnIpIHtcblx0XHRpZiAoZXJyKSB7XG5cdFx0XHRhbGVydChlcnIudG9TdHJpbmcoKSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGZiLnVuYXV0aCgpO1xuXHRcdH1cblx0fSk7XG5cdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG59KTtcblxuJCgnLmRvUmVzZXRQYXNzd29yZCcpLmNsaWNrKGZ1bmN0aW9uKCkge1xuXHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHR2YXIgZW1haWwgPSAkKCcubG9naW4tcGFnZSBpbnB1dFt0eXBlPVwiZW1haWxcIl0nKS52YWwoKTtcblxuXHRmYi5yZXNldFBhc3N3b3JkKHtcblx0XHRlbWFpbDogZW1haWxcblx0fSwgZnVuY3Rpb24oZXJyKSB7XG5cdFx0aWYgKGVycikge1xuXHRcdFx0YWxlcnQoZXJyLnRvU3RyaW5nKCkpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRhbGVydChcIlBsZWFzZSBjaGVjayB5b3VyIGVtYWlsIGZvciBmdXJ0aGVyIGluc3RydWN0aW9ucy5cIik7XG5cdFx0fVxuXHR9KTtcbn0pO1xuXG5mdW5jdGlvbiBkb0xvZ2luKGVtYWlsLCBwYXNzd29yZCwgY2FsbGJhY2spIHtcblx0ZmIuYXV0aFdpdGhQYXNzd29yZCh7XG5cdFx0ZW1haWw6IGVtYWlsLFxuXHRcdHBhc3N3b3JkOiBwYXNzd29yZFxuXHR9LCBmdW5jdGlvbihlcnIsIGF1dGhEYXRhKXtcblx0XHRpZiAoZXJyKSB7XG5cdFx0XHRhbGVydChlcnIudG9TdHJpbmcoKSk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHNhdmVBdXRoRGF0YShhdXRoRGF0YSk7XG5cdFx0XHR0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicgJiYgY2FsbGJhY2soYXV0aERhdGEpO1xuXHRcdH1cblx0fSk7XG59XG5cbmZ1bmN0aW9uIHNhdmVBdXRoRGF0YSAoYXV0aERhdGEpIHtcblx0JC5hamF4KHtcbiAgICBtZXRob2Q6ICdQVVQnLFxuICAgIHVybDogYCR7RklSRUJBU0VfQVVUSF9VUkx9L3VzZXJzLyR7YXV0aERhdGEudWlkfS9wcm9maWxlLmpzb25gLFxuICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KGF1dGhEYXRhKVxuXHR9KTtcbn1cblxuZnVuY3Rpb24gY2xlYXJMb2dpbkZvcm0oKSB7XG5cdCQoJy5sb2dpbi1wYWdlIGlucHV0W3R5cGU9XCJlbWFpbFwiXScpLnZhbCgnJyk7XG5cdCQoJy5sb2dpbi1wYWdlIGlucHV0W3R5cGU9XCJwYXNzd29yZFwiXScpLnZhbCgnJyk7XG59XG5cbi8vdGFibGVMb2FkKCk7XG5cbmZ1bmN0aW9uIGdldFNlYXJjaFBhcmFtcygpIHtcbiAgdmFyIG1vdmllX3RpdGxlID0gJFRFWFRGSUVMRC52YWwoKTtcbiAgdmFyIHNlYXJjaF9wYXJhbXMgPSBtb3ZpZV90aXRsZS5zcGxpdChcIiBcIikuam9pbihcIitcIik7XG4gIHJldHVybiBzZWFyY2hfcGFyYW1zO1xufVxuXG4kU1VCTUlUQlVUVE9OLmNsaWNrKGZ1bmN0aW9uKGV2ZW50KSB7XG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gIHZhciB0bWRiX3NlYXJjaF91cmwgPSBUTURCX1NFQVJDSF9VUkwgKyBUTURCX0FQSV9LRVkgKyBcIiZxdWVyeT1cIiArIGdldFNlYXJjaFBhcmFtcygpO1xuICAkLmdldCh0bWRiX3NlYXJjaF91cmwsIHNldFBvc3RlclVybCwgJ2pzb25wJyk7XG59KVxuXG5mdW5jdGlvbiBzZXRQb3N0ZXJVcmwob2JqKSB7XG4gIGlmIChvYmoudG90YWxfcmVzdWx0cyA9PT0gMCkge1xuICAgICRNT1ZJRUlORk8uZW1wdHkoKTtcbiAgICAkTU9WSUVJTkZPLmFwcGVuZChtYWtlRXJyb3IoKSk7XG4gICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICQoXCIuZXJyb3JcIikuZmFkZU91dCg1MDAsIGZ1bmN0aW9uKCkge1xuICAgICAgICAkKFwiLmVycm9yXCIpLnJlbW92ZSgpO1xuICAgICAgfSlcbiAgICB9LCAzMDAwKVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICB2YXIgcG9zdGVyX3BhdGggPSBvYmoucmVzdWx0cyAmJiBvYmoucmVzdWx0c1swXSAmJiBvYmoucmVzdWx0c1swXS5wb3N0ZXJfcGF0aDtcbiAgcG9zdGVyX3VybCA9IFRNREJfUE9TVEVSX0JBU0UgKyBwb3N0ZXJfcGF0aCArIFRNREJfQVBJX0tFWTtcbiAgLy8gaGF2ZSB0aGUgcG9zdGVyIHVybDsgbm93IGdldCB0aGUgcmVzdCBvZiB0aGUgZGF0YSBhY2NvcmRpbmcgdG8gdGhlIHRpdGxlIGFzIGl0IHdhcyByZXR1cm4gYnkgdGhlXG4gIC8vIG9iamVjdCBiZWFyaW5nIHRoZSBwb3N0ZXIgcGF0aCAodG8ga2VlcCBjb25zaXN0ZW5jeSBiZXR3ZWVuIGJvdGggQVBJcycgc2VhcmNoIHJlc3VsdHMpLlxuICB2YXIgcmVxdWVzdF91cmwgPSBBUElfVVJMICsgKG9iai5yZXN1bHRzICYmIG9iai5yZXN1bHRzWzBdICYmIG9iai5yZXN1bHRzWzBdLm9yaWdpbmFsX3RpdGxlLnNwbGl0KFwiIFwiKS5qb2luKFwiK1wiKSk7XG4gICQuZ2V0KHJlcXVlc3RfdXJsLCBhZGRNb3ZpZUluZm8sICdqc29ucCcpO1xufVxuXG4kTU9WSUVJTkZPLm9uKCdjbGljaycsICcuYWRkLWJ1dHRvbicsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gIHdyaXRlVG9GaXJlYmFzZShtb3ZpZV9pbmZvX29iaik7XG59KVxuXG4kTU9WSUVUQUJMRUNPTlRBSU5FUi5vbignY2xpY2snLCAnYnV0dG9uJywgZnVuY3Rpb24oZXZlbnQpIHtcbiAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgZGVsZXRlRnJvbUZpcmViYXNlKCQodGhpcykuY2xvc2VzdCgndHInKS5hdHRyKCdkYXRhX2lkJykpO1xuICAkKHRoaXMpLmNsb3Nlc3QoJ3RyJykuZmFkZU91dCg1MDAsIGZ1bmN0aW9uKCkge1xuICAgICQodGhpcykuY2xvc2VzdCgndHInKS5yZW1vdmUoKTtcbiAgICBpZiAoISgkKCd0ZCcpLmxlbmd0aCkpIHtcbiAgICAgICQoJ3RhYmxlJykucmVtb3ZlKCk7XG4gICAgfVxuICB9KTtcbn0pXG5cbiRNT1ZJRVRBQkxFQ09OVEFJTkVSLm9uKCdjbGljaycsICdpbWcnLCBmdW5jdGlvbihldmVudCkge1xuICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICB2YXIgaWQgPSAkKHRoaXMpLmNsb3Nlc3QoJ3RyJykuYXR0cignZGF0YV9pZCcpO1xuICAkLmdldChgJHtGSVJFQkFTRV9BVVRIX1VSTH0vdXNlcnMvJHtmYi5nZXRBdXRoKCkudWlkfS9tb3ZpZWxpc3QvJHtpZH0uanNvbmAsIHJlQ2xpY2ssIFwianNvbnBcIik7XG59KVxuXG4vLyByZUNsaWNrIGlzIGZvciByZWxvYWRpbmcgc3RvcmVkIG1vdmllcyBpbnRvIHRoZSBtb3ZpZSBpbmZvIHZpZXc7IGRvbid0IG5lZWQgdG8gcmV3cml0ZSB0aGUgcG9zdGVyIHVybC5cbmZ1bmN0aW9uIHJlQ2xpY2sob2JqKSB7XG4gIG1vdmllX2luZm9fb2JqID0gb2JqO1xuICAkTU9WSUVJTkZPLmVtcHR5KCk7XG4gICRNT1ZJRUlORk8uYXBwZW5kKG1ha2VNb3ZpZUluZm8ob2JqKSk7XG59XG5cbmZ1bmN0aW9uIGFkZE1vdmllSW5mbyhvYmopIHtcbiAgbW92aWVfaW5mb19vYmogPSBvYmo7XG4gIG1vdmllX2luZm9fb2JqLlBvc3RlciA9IHBvc3Rlcl91cmw7XG4gICRNT1ZJRUlORk8uZW1wdHkoKTtcbiAgJE1PVklFSU5GTy5hcHBlbmQobWFrZU1vdmllSW5mbyhvYmopKTtcbn1cblxuZnVuY3Rpb24gbWFrZUVycm9yKCkge1xuICB2YXIgJGVycm9yID0gJCgnPGRpdj48cD4owrTvvKHvvYDjgIIpIE5vIHJlc3VsdHMhPC9wPjwvZGl2PicpXG4gICRlcnJvci5hZGRDbGFzcyhcImVycm9yXCIpO1xuICByZXR1cm4gJGVycm9yO1xufVxuXG5mdW5jdGlvbiBtYWtlTW92aWVJbmZvKG9iaikge1xuICB2YXIgJGluZm9fY29udGFpbmVyID0gJCgnPGRpdj48L2Rpdj4nKTtcbiAgJGluZm9fY29udGFpbmVyLmFkZENsYXNzKFwiaW5mby1jb250YWluZXJcIik7XG4gIHZhciAkdGl0bGUgPSAkKFwiPHA+XCIgKyBvYmouVGl0bGUgKyBcIjwvcD5cIik7XG4gIHZhciAkaW5mbyA9ICQobWFrZVJhdGluZ0ltZ1RleHQob2JqKSsgXCI8c3BhbiBcIiArIG1ha2VNZXRhUmF0aW5nVGV4dChvYmopICsgXCI8L3NwYW4+PHAgY2xhc3M9J2ltZGItcmF0aW5nJz5cIiArIG9iai5pbWRiUmF0aW5nICsgXCI8L3A+PC9zcGFuPjxzcGFuPlllYXI6IFwiICsgb2JqLlllYXIgKyBcIjwvc3Bhbj5cIik7XG4gICR0aXRsZS5hZGRDbGFzcyhcInRpdGxlXCIpO1xuICB2YXIgJGRpcmVjdG9yID0gJChcIjxwPkRpcmVjdG9yOiBcIiArIG9iai5EaXJlY3RvciArIFwiPC9wPlwiKTtcbiAgdmFyICRwbG90ID0gJChcIjxwPlwiICsgb2JqLlBsb3QgKyBcIjwvcD5cIik7XG4gIHZhciAkcnVudGltZSA9ICQoXCI8cD5cIiArIG9iai5SdW50aW1lICsgXCI8L3A+XCIpO1xuICB2YXIgJGFkZF9idXR0b24gPSAkKFwiPGJ1dHRvbj5BZGQgdG8gbXkgbGlzdDwvYnV0dG9uPlwiKTtcbiAgJGFkZF9idXR0b24uYWRkQ2xhc3MoXCJhZGQtYnV0dG9uIGJ0biBidG4tbGcgYnRuLXN1Y2Nlc3MgcHVsbC1yaWdodFwiKTtcbiAgXG4gIHZhciAkcG9zdGVyID0gJChcIjxpbWcgc3JjPSdcIiArIG9iai5Qb3N0ZXIgKyBcIic+PC9pbWc+XCIpO1xuICAkcG9zdGVyLmFkZENsYXNzKFwicHVsbC1sZWZ0XCIpO1xuICAkaW5mb19jb250YWluZXIuYXBwZW5kKCRwb3N0ZXIpO1xuICAkaW5mb19jb250YWluZXIuYXBwZW5kKCR0aXRsZSkuYXBwZW5kKCRpbmZvKS5hcHBlbmQoJGRpcmVjdG9yKS5hcHBlbmQoJHBsb3QpLmFwcGVuZCgkcnVudGltZSkuYXBwZW5kKCRhZGRfYnV0dG9uKTtcbiAgcmV0dXJuICRpbmZvX2NvbnRhaW5lcjtcbn1cblxuZnVuY3Rpb24gYWRkVG9UYWJsZShvYmosIGlkKSB7XG4gIGlmICghKCQoXCJ0YWJsZVwiKS5sZW5ndGgpKSB7XG4gICAgJE1PVklFVEFCTEVDT05UQUlORVIuYXBwZW5kKG1ha2VUYWJsZUhlYWRlcigpKTtcbiAgfVxuICAkKFwidGFibGVcIikuYXBwZW5kKG1ha2VUYWJsZVJvdyhvYmosIGlkKSk7XG59XG5cbmZ1bmN0aW9uIG1ha2VUYWJsZUhlYWRlcigpIHtcbiAgdmFyICR0YWJsZT0gJChcIjx0YWJsZT48L3RhYmxlPlwiKTtcbiAgJHRhYmxlLmFkZENsYXNzKFwidGFibGUgdGFibGUtc3RyaXBlZFwiKTtcbiAgdmFyICRoZWFkZXJfcm93ID0gJChcIjx0cj48L3RyPlwiKTtcbiAgdmFyICRoZWFkZXJfZWxlbWVudHMgPSAkKFwiPHRoPjwvdGg+PHRoPlRpdGxlPC90aD48dGg+WWVhcjwvdGg+PHRoPlJhdGluZzwvdGg+PHRoPk1ldGFzY29yZTwvdGg+PHRoPmltZGI8L3RoPjx0aD48L3RoPlwiKTtcbiAgJGhlYWRlcl9yb3cuYXBwZW5kKCRoZWFkZXJfZWxlbWVudHMpO1xuICAkdGFibGUuYXBwZW5kKCRoZWFkZXJfcm93KTtcbiAgcmV0dXJuICR0YWJsZTtcbn1cblxuZnVuY3Rpb24gbWFrZVRhYmxlUm93KG9iaiwgaWQpIHtcbiAgdmFyICRyb3cgPSAkKFwiPHRyPjwvdHI+XCIpO1xuICB2YXIgJHBvc3Rlcl90ZDtcbiAgJHJvdy5hdHRyKFwiZGF0YV9pZFwiLCBpZCB8fCBvYmouZGF0YV9pZCk7XG4gIG9iai5Qb3N0ZXIgPT09IFwiTi9BXCIgPyAkcG9zdGVyX3RkID0gJChcIjx0ZD48aW1nIHNyYz0nXCIgKyBcImh0dHBzOi8vd3d3LnV0b3BvbGlzLmx1L2J1bmRsZXMvdXRvcG9saXNjb21tb24vaW1hZ2VzL21vdmllcy9tb3ZpZS1wbGFjZWhvbGRlci5qcGdcIiArIFwiJz48L3RkPlwiKSA6ICRwb3N0ZXJfdGQgPSAkKFwiPHRkPjxpbWcgc3JjPSdcIiArIG9iai5Qb3N0ZXIgKyBcIic+PC9zcmM+XCIpO1xuICB2YXIgb3RoZXJfcm93cyA9IFwiPHRkPlwiICsgb2JqLlRpdGxlICsgXCI8L3RkPjx0ZD5cIiArIG9iai5ZZWFyICsgXCI8L3RkPjx0ZD5cIjtcbiAgb3RoZXJfcm93cyArPSBtYWtlUmF0aW5nSW1nVGV4dChvYmopO1xuICBvdGhlcl9yb3dzICs9IFwiPC90ZD48dGQ+PHAgXCIgKyBtYWtlTWV0YVJhdGluZ1RleHQob2JqKSArIFwiPC9wPjwvdGQ+XCI7XG4gIG90aGVyX3Jvd3MgKz0gXCI8dGQ+PHAgY2xhc3M9J2ltZGItcmF0aW5nJz5cIiArIG9iai5pbWRiUmF0aW5nICsgXCI8L3A+PC90ZD5cIjtcbiAgb3RoZXJfcm93cyArPSBcIjx0ZD48YnV0dG9uPldhdGNoZWQ8L2J1dHRvbj48L3RkPlwiO1xuICB2YXIgJG90aGVyX3Jvd3MgPSAkKG90aGVyX3Jvd3MpO1xuICAkb3RoZXJfcm93cy5maW5kKFwiYnV0dG9uXCIpLmFkZENsYXNzKFwiYnRuIGJ0bi1sZyBidG4tZGFuZ2VyXCIpO1xuICAkcm93LmFwcGVuZCgkcG9zdGVyX3RkKS5hcHBlbmQoJG90aGVyX3Jvd3MpO1xuICByZXR1cm4gJHJvdztcbn1cblxuZnVuY3Rpb24gbWFrZU1ldGFSYXRpbmdUZXh0KG9iaikge1xuXHR2YXIgcmV0dXJuX3N0ciA9IFwiY2xhc3M9J21ldGFzY29yZSBcIjtcblx0aWYgKHBhcnNlSW50KG9iai5NZXRhc2NvcmUpID4gNjApIHtcbiAgXHRyZXR1cm5fc3RyICs9IFwibWV0YS1wb3NpdGl2ZVwiO1xuICB9IGVsc2UgaWYgKHBhcnNlSW50KG9iai5NZXRhc2NvcmUpID4gMzkpIHtcbiAgXHRyZXR1cm5fc3RyICs9IFwibWV0YS1uZXV0cmFsXCI7XG4gIH0gZWxzZSBpZiAocGFyc2VJbnQob2JqLk1ldGFzY29yZSkgPj0gMCkge1xuICBcdHJldHVybl9zdHIgKz0gXCJtZXRhLW5lZ2F0aXZlXCI7XG4gIH1cbiAgcmV0dXJuX3N0ciArPSBcIic+XCIrIG9iai5NZXRhc2NvcmVcbiAgcmV0dXJuIHJldHVybl9zdHI7XG59XG5cbmZ1bmN0aW9uIG1ha2VSYXRpbmdJbWdUZXh0KG9iaikge1xuXHRpZiAob2JqLlJhdGVkID09PSBcIkdcIikge1xuICBcdHJldHVybiBcIjxpbWcgY2xhc3M9J3JhdGluZy1pbWcnIHNyYz0nLi4vaW1hZ2VzL0cuc3ZnJz5cIjtcbiAgfSBlbHNlIGlmIChvYmouUmF0ZWQgPT09IFwiUEdcIikge1xuICBcdHJldHVybiBcIjxpbWcgY2xhc3M9J3JhdGluZy1pbWcnIHNyYz0nLi4vaW1hZ2VzL1BHLnN2Zyc+XCI7XG4gIH0gZWxzZSBpZiAob2JqLlJhdGVkID09PSBcIlBHLTEzXCIpIHtcbiAgXHRyZXR1cm4gXCI8aW1nIGNsYXNzPSdyYXRpbmctaW1nJyBzcmM9Jy4uL2ltYWdlcy9QRy0xMy5zdmcnPlwiO1xuICB9IGVsc2UgaWYgKG9iai5SYXRlZCA9PT0gXCJSXCIpIHtcbiAgXHRyZXR1cm4gXCI8aW1nIGNsYXNzPSdyYXRpbmctaW1nJyBzcmM9Jy4uL2ltYWdlcy9SLnN2Zyc+XCI7XG4gIH0gZWxzZSBpZiAob2JqLlJhdGVkID09PSBcIk5DLTE3XCIpIHtcbiAgXHRyZXR1cm4gXCI8aW1nIGNsYXNzPSdyYXRpbmctaW1nJyBzcmM9Jy4uL2ltYWdlcy9OQy0xNy5zdmcnPlwiO1xuICB9IGVsc2Uge1xuICBcdHJldHVybiBcIjxzcGFuPk4vQTwvc3Bhbj5cIlxuICB9XG59XG5cbmZ1bmN0aW9uIHdyaXRlVG9GaXJlYmFzZShvYmopIHtcbiAgJC5wb3N0KGAke0ZJUkVCQVNFX0FVVEhfVVJMfS91c2Vycy8ke2ZiLmdldEF1dGgoKS51aWR9L21vdmllbGlzdC5qc29uYCwgSlNPTi5zdHJpbmdpZnkob2JqKSwgZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICBvYmouZGF0YV9pZCA9IHJlc3BvbnNlLm5hbWU7XG4gICAgYWRkVG9UYWJsZShvYmopO1xuICB9KVxufVxuXG5mdW5jdGlvbiBkZWxldGVGcm9tRmlyZWJhc2UoaWQpIHtcbiAgdmFyIGRlbGV0ZVVybCA9IGAke0ZJUkVCQVNFX0FVVEhfVVJMfS91c2Vycy8ke2ZiLmdldEF1dGgoKS51aWR9L21vdmllbGlzdC8ke2lkfS5qc29uYDtcbiAgJC5hamF4KHt1cmw6IGRlbGV0ZVVybCwgdHlwZTogJ0RFTEVURSd9KTtcbn1cblxuZnVuY3Rpb24gdGFibGVMb2FkKCkge1xuICAkLmdldChgJHtGSVJFQkFTRV9BVVRIX1VSTH0vdXNlcnMvJHtmYi5nZXRBdXRoKCkudWlkfS9tb3ZpZWxpc3QuanNvbmAsIGZ1bmN0aW9uKGRiX2RhdGEpIHtcbiAgICBkYl9kYXRhICYmIF8oZGJfZGF0YSkuZm9yRWFjaChmdW5jdGlvbih2YWx1ZSwga2V5KSB7XG4gICAgICBhZGRUb1RhYmxlKHZhbHVlLCBrZXkpO1xuICAgIH0pLnZhbHVlKCk7XG4gIH0pXG59XG4iXX0=
