"use strict";function doLogin(a,b,c){fb.authWithPassword({email:a,password:b},function(a,b){a?alert(a.toString()):"function"==typeof c&&c(b)})}function saveAuthData(a){var b=fb.child("users/"+a.uid+"/profile");b.set(a,postAuthRouting(a))}function postAuthRouting(a){a&&a.password.isTemporaryPassword&&"/movieagenda/resetpassword/"!==window.location.pathname?window.location.pathname="movieagenda/resetpassword/":a&&!a.password.isTemporaryPassword&&"/movieagenda/table/"!==window.location.pathname&&(window.location.pathname="movieagenda/table/")}function clearLoginForm(){$('.login-page input[type="email"]').val(""),$('.login-page input[type="password"]').val("")}function getSearchParams(){var a=$TEXTFIELD.val(),b=a.split(" ").join("+");return b}function setPosterUrl(a){if(0===a.total_results)return $MOVIEINFO.empty(),$MOVIEINFO.append(makeError()),setTimeout(function(){$(".error").fadeOut(500,function(){$(".error").remove()})},3e3),!1;var b=a.results&&a.results[0]&&a.results[0].poster_path;poster_url=TMDB_POSTER_BASE+b+TMDB_API_KEY;var c=API_URL+(a.results&&a.results[0]&&a.results[0].original_title.split(" ").join("+"));$.get(c,addMovieInfo,"jsonp")}function reClick(a){movie_info_obj=a,$MOVIEINFO.empty(),$MOVIEINFO.append(makeMovieInfo(a))}function addMovieInfo(a){movie_info_obj=a,movie_info_obj.Poster=poster_url,$MOVIEINFO.empty(),$MOVIEINFO.append(makeMovieInfo(a))}function makeError(){var a=$("<div><p>(´Ａ｀。) No results!</p></div>");return a.addClass("error"),a}function makeMovieInfo(a){var b=$("<div></div>");b.addClass("info-container");var c=$("<p>"+a.Title+"</p>"),d=$(makeRatingImgText(a)+"<button class='trailer-btn btn btn-sm btn-default' query='"+a.Title.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(" ").join("-")+"'>View clips</button><span "+makeMetaRatingText(a)+"</span><p class='imdb-rating'>"+a.imdbRating+"</p></span><span>&nbsp"+a.Year+"</span><span>&nbsp&nbsp&nbsp"+a.Runtime+"</span>");c.addClass("title");var e=$("<p>Director: "+a.Director+"</p>"),f=$("<p>"+a.Plot+"</p>"),g=$("<button>Add to my list</button>");g.addClass("add-button btn btn-lg btn-success pull-right");var h=$("<img src='"+a.Poster+"'></img>");return h.addClass("pull-left"),b.append(h),b.append(c).append(d).append(e).append(f).append(g),b}function addToTable(a,b){$("table").length||$MOVIETABLECONTAINER.append(makeTableHeader()),$("table").append(makeTableRow(a,b))}function makeTableHeader(){var a=$("<table></table>");a.addClass("table table-striped");var b=$("<tr></tr>"),c=$("<th></th><th>Title</th><th>Year</th><th>Rating</th><th>Clips</th><th>Metascore</th><th>imdb</th><th></th>");return b.append(c),a.append(b),a}function makeTableRow(a,b){var c,d=$("<tr></tr>");d.attr("data_id",b||a.data_id),c="N/A"===a.Poster?$("<td><img src='https://www.utopolis.lu/bundles/utopoliscommon/images/movies/movie-placeholder.jpg'></td>"):$("<td><img src='"+a.Poster+"'></src>");var e="<td>"+a.Title+"</td><td>"+a.Year+"</td><td>";e+=makeRatingImgText(a),e+="</td>",e+="<td><button class='trailer-btn' query='"+a.Title.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g,"").split(" ").join("-")+"'>View</button>",e+="<td><p "+makeMetaRatingText(a)+"</p></td>",e+="<td><p class='imdb-rating'>"+a.imdbRating+"</p></td>",e+="<td><button class='watched-btn'>Watched</button></td>";var f=$(e);return f.find("button.watched-btn").addClass("btn btn-md btn-danger"),f.find("button.trailer-btn").addClass("btn btn-md btn-default"),d.append(c).append(f),d}function makeMetaRatingText(a){var b="class='metascore ";return parseInt(a.Metascore)>60?b+="meta-positive":parseInt(a.Metascore)>39?b+="meta-neutral":parseInt(a.Metascore)>=0&&(b+="meta-negative"),b+="'>"+a.Metascore}function makeRatingImgText(a){return"G"===a.Rated?"<img class='rating-img' src='../images/G.svg'>":"PG"===a.Rated?"<img class='rating-img' src='../images/PG.svg'>":"PG-13"===a.Rated?"<img class='rating-img' src='../images/PG-13.svg'>":"R"===a.Rated?"<img class='rating-img' src='../images/R.svg'>":"NC-17"===a.Rated?"<img class='rating-img' src='../images/NC-17.svg'>":"<span>N/A</span>"}function writeToFirebase(a){var b=movielist.push(a);a.data_id=b.key()}function deleteFromFirebase(a){movielist.child(a).set(null)}var FIREBASE_URL="https://movieagenda.firebaseio.com",fb=new Firebase(FIREBASE_URL),movielist,API_URL="http://www.omdbapi.com/?t=",$SUBMITBUTTON=$(".submit"),$TEXTFIELD=$(".textfield"),$MOVIEINFO=$(".movie-info"),$MOVIETABLECONTAINER=$(".movie-table-container"),movie_info_obj,poster_url,TMDB_API_KEY="?api_key=3d3efaa01fcce58b6e8758f0f9d9c93d",TMDB_SEARCH_URL="http://api.themoviedb.org/3/search/movie",TMDB_POSTER_BASE="http://image.tmdb.org/t/p/w500",TRAILER_API_URL="http://crossorigin.me/http://api.traileraddict.com/?film=";fb.onAuth(function(a){a||"/movieagenda/login/"===window.location.pathname?a&&saveAuthData(a):window.location.pathname="movieagenda/login/",clearLoginForm()}),"/movieagenda/table/"===window.location.pathname&&($(".crumbs-left").append($("<p>Welcome, "+fb.getAuth().password.email.split("@")[0]+"!</p>")),movielist=fb.child("users/"+fb.getAuth().uid+"/movielist"),movielist.on("child_added",function(a){addToTable(a.val(),a.key())}),movielist.on("child_removed",function(a){$("[data_id='"+a.key()+"']").fadeOut(500,function(){$(this).closest("tr").remove(),$("td").length||$("table").remove()})})),$(".login-page form").submit(function(a){a.preventDefault();var b=$('.login-page input[type="email"]').val(),c=$('.login-page input[type="password"]').val();doLogin(b,c)}),$(".doLogout").click(function(){fb.unauth()}),$(".doRegister").click(function(a){a.preventDefault();var b=$('.login-page input[type="email"]').val(),c=$('.login-page input[type="password"]').val();fb.createUser({email:b,password:c},function(a,d){a?alert(a.toString()):doLogin(b,c)})}),$(".reset-password form").submit(function(){var a=fb.getAuth().password.email,b=$("#oldpass").val(),c=$("#newpass").val();fb.changePassword({email:a,oldPassword:b,newPassword:c},function(a){a?alert(a.toString()):fb.unauth()}),event.preventDefault()}),$(".doResetPassword").click(function(){event.preventDefault();var a=$('.login-page input[type="email"]').val();fb.resetPassword({email:a},function(a){a?alert(a.toString()):alert("Please check your email for further instructions.")})}),$SUBMITBUTTON.click(function(a){a.preventDefault();var b=TMDB_SEARCH_URL+TMDB_API_KEY+"&query="+getSearchParams();$.get(b,setPosterUrl,"jsonp")}),$MOVIEINFO.on("click",".add-button",function(a){a.preventDefault(),writeToFirebase(movie_info_obj)}),$MOVIETABLECONTAINER.on("click","button.watched-btn",function(a){a.preventDefault(),deleteFromFirebase($(this).closest("tr").attr("data_id"))}),$(".movie-info, .movie-table-container").on("click","button.trailer-btn",function(a){a.preventDefault();var b=$(this).attr("query");$.get(TRAILER_API_URL+b+"&count=10",function(a){var b=$.parseXML(a),c=$($(b).find("embed")),d=$.map(c,function(a){return $(a).text()});$.fancybox(d)})}),$MOVIETABLECONTAINER.on("click","img",function(a){a.preventDefault();var b=$(this).closest("tr").attr("data_id");movielist.child(b).once("value",function(a){reClick(a.val())})});